<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard PISA — Matemática (Argentina)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{background:#f5f7fb;font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    .hero{background:linear-gradient(90deg,#0b5ed7,#063a78);color:#fff;padding:18px;border-radius:8px;margin:12px 0}
    .card{border-radius:8px;box-shadow:0 6px 18px rgba(16,24,40,0.06);background:#fff}
    #map{height:300px;border-radius:8px}
    .chart-area{height:340px}
    @media (max-width:767px){ .chart-area{height:260px} #map{height:220px} }
  </style>
</head>
<body>

<div class="container my-3">
  <div class="hero d-flex align-items-center justify-content-between">
    <div>
      <h3 class="mb-0">Dashboard PISA — Matemática (Argentina)</h3>
      <small class="text-white-50">Serie embebida: 2000 → 2022</small>
    </div>
    <div>
      <button id="download-csv" class="btn btn-light btn-sm">Descargar CSV (PISA)</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="card p-3 mb-3">
        <h5 class="mb-2">Evolución del Puntaje (PISA) — Matemática</h5>
        <div class="chart-area">
          <canvas id="pisaLineChart"></canvas>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <h5 class="mb-2">Mapa — Posición Nacional</h5>
        <div id="map"></div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card p-3 mb-3">
        <h6 class="mb-2">Detalles de la Serie</h6>
        <p class="small text-muted">Valores PISA (Matemática) — Argentina</p>
        <div style="max-height:340px; overflow:auto;">
          <table id="pisa-table" class="table table-sm table-striped">
            <thead class="table-light"><tr><th>Año</th><th>Score Matemática</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card p-3">
        <h6 class="mb-2">Controles / Vista previa</h6>
        <p class="small text-muted">Seleccioná el rango de años que querés ver en el gráfico.</p>
        <div class="mb-2">
          <label class="form-label small">Año inicio</label>
          <select id="yearStart" class="form-select form-select-sm"></select>
        </div>
        <div class="mb-2">
          <label class="form-label small">Año fin</label>
          <select id="yearEnd" class="form-select form-select-sm"></select>
        </div>
        <div class="d-grid gap-2">
          <button id="btn-update-range" class="btn btn-primary btn-sm">Aplicar rango</button>
          <button id="btn-reset-range" class="btn btn-outline-secondary btn-sm">Restaurar todo</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-3 small text-muted">
    Fuente: OECD PISA — datos embebidos para visualización. Para reemplazar por un CSV real, usa la funcionalidad de descarga y subí tu archivo con el mismo formato.
  </footer>
</div>

<!-- Librerías -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
/* ===============================
   Serie PISA embebida (opción 1)
   =============================== */
const PISA_SERIE = [
  { anio: 2000, score: 388 },
  { anio: 2003, score: 385 },
  { anio: 2006, score: 381 },
  { anio: 2009, score: 388 },
  { anio: 2012, score: 396 },
  { anio: 2015, score: 409 },
  { anio: 2018, score: 379 },
  { anio: 2022, score: 360 }
];

/* función para obtener CSV desde la serie embebida */
function pisaToCSV(arr){
  const header = ['anio','pais','score_matematica'];
  const lines = arr.map(r => `${r.anio},Argentina,${r.score}`);
  return header.join(',') + '\n' + lines.join('\n');
}

/* Descargar CSV */
document.getElementById('download-csv').addEventListener('click', () => {
  const csv = pisaToCSV(PISA_SERIE);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'pisa_serie_argentina.csv';
  a.click(); URL.revokeObjectURL(url);
});

/* ========== Inicializar Mapa ========== */
const map = L.map('map', { zoomControl: true }).setView([-34.5, -64], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
const markersGroup = L.featureGroup().addTo(map); // FeatureGroup -> getBounds()

/* Crear marcador nacional (puntaje más reciente) */
function updateMapWithLatest(series){
  markersGroup.clearLayers();
  const last = series.slice().sort((a,b)=>a.anio-b.anio).pop();
  if (!last) return;
  const score = Number(last.score);
  const color = score >= 400 ? '#2ca02c' : score >= 380 ? '#ffbf00' : '#d62728';
  const marker = L.circleMarker([-34.5, -64], { radius: 14, fillOpacity: .85, color }).bindPopup(`<strong>Argentina (PISA)</strong><br>Año: ${last.anio}<br>Score: ${score}`);
  markersGroup.addLayer(marker);
  map.fitBounds(markersGroup.getBounds().pad(0.4));
}

/* ========== Tabla y controles ========== */
const tbody = document.querySelector('#pisa-table tbody');
function renderTable(series){
  tbody.innerHTML = '';
  series.slice().sort((a,b)=>b.anio-a.anio).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.anio}</td><td>${r.score}</td>`;
    tbody.appendChild(tr);
  });
}

/* Rango año: llenar selects */
function fillYearSelects(series){
  const years = series.map(s=>s.anio).sort((a,b)=>a-b);
  const start = document.getElementById('yearStart');
  const end = document.getElementById('yearEnd');
  start.innerHTML = ''; end.innerHTML = '';
  years.forEach(y => {
    const o1 = document.createElement('option'); o1.value=y; o1.text=y; start.appendChild(o1);
    const o2 = document.createElement('option'); o2.value=y; o2.text=y; end.appendChild(o2);
  });
  // defaults: full range
  start.value = years[0]; end.value = years[years.length-1];
}

/* ========== Chart.js ========== */
const ctx = document.getElementById('pisaLineChart').getContext('2d');
const pisaChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: PISA_SERIE.map(s=>s.anio),
    datasets: [{
      label: 'PISA - Puntaje Matemática (Argentina)',
      data: PISA_SERIE.map(s=>s.score),
      tension: 0.3,
      fill: true,
      backgroundColor: 'rgba(11,94,215,0.08)',
      borderColor: '#0b5ed7',
      pointRadius: 6,
      pointHoverRadius: 8
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: { beginAtZero: false, suggestedMin: 300, suggestedMax: 450 }
    },
    plugins: { legend: { display: true } }
  }
});

/* Filtrar por rango de años y actualizar gráficos/tabla/mapa */
function applyRangeFilter(){
  const yStart = Number(document.getElementById('yearStart').value);
  const yEnd = Number(document.getElementById('yearEnd').value);
  const filtered = PISA_SERIE.filter(s => s.anio >= yStart && s.anio <= yEnd).sort((a,b)=>a.anio-b.anio);
  // actualizar chart
  pisaChart.data.labels = filtered.map(s=>s.anio);
  pisaChart.data.datasets[0].data = filtered.map(s=>s.score);
  pisaChart.update();
  // tabla & map (map uses last in filtered or global)
  renderTable(filtered);
  updateMapWithLatest(filtered.length ? filtered : PISA_SERIE);
}

/* Reset rango */
document.getElementById('btn-reset-range').addEventListener('click', ()=> {
  fillYearSelects(PISA_SERIE);
  pisaChart.data.labels = PISA_SERIE.map(s=>s.anio);
  pisaChart.data.datasets[0].data = PISA_SERIE.map(s=>s.score);
  pisaChart.update();
  renderTable(PISA_SERIE);
  updateMapWithLatest(PISA_SERIE);
});

/* Aplicar rango */
document.getElementById('btn-update-range').addEventListener('click', applyRangeFilter);

/* Inicializar vista al cargar */
(function init(){
  fillYearSelects(PISA_SERIE);
  renderTable(PISA_SERIE);
  updateMapWithLatest(PISA_SERIE);
})();

</script>
</body>
</html>
