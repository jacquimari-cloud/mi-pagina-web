<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - Rendimiento en Matemática (Argentina)</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { background:#f6f7fb; }
    .card-kpi { min-height:110px; }
    .chart-container { padding: 12px; background: #ffffff; border-radius: 8px; box-shadow: 0 1px 4px rgba(10,10,10,0.04); }
    .small-muted { font-size:0.85rem; color:#6b7280; }
    .cursor-pointer { cursor: pointer; }
  </style>
</head>
<body>
  <div class="container-fluid p-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-0">Dashboard: Rendimiento en Matemática — Argentina</h3>
        <div class="small-muted">Indicadores por provincia, nivel y año. Datos de ejemplo.</div>
      </div>
      <div>
        <div class="row gx-2">
          <div class="col-auto">
            <select id="selectYear" class="form-select form-select-sm" aria-label="Año"></select>
          </div>
          <div class="col-auto">
            <select id="selectLevel" class="form-select form-select-sm" aria-label="Nivel"></select>
          </div>
          <div class="col-auto">
            <button id="btnDownload" class="btn btn-sm btn-outline-primary">Descargar CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card card-kpi p-3 chart-container">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="small-muted">Promedio Nacional</div>
              <h2 id="kpiAvg">--</h2>
            </div>
            <div class="text-end small-muted">
              <div id="kpiYear">Año --</div>
              <div id="kpiLevel">Nivel --</div>
            </div>
          </div>
          <div class="small-muted mt-2">Puntaje promedio en pruebas de matemática (0-100)</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-kpi p-3 chart-container">
          <div class="small-muted">Mejor Provincia</div>
          <h4 id="kpiBest">--</h4>
          <div class="small-muted">Puntaje: <span id="kpiBestScore">--</span></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-kpi p-3 chart-container">
          <div class="small-muted">Peor Provincia</div>
          <h4 id="kpiWorst">--</h4>
          <div class="small-muted">Puntaje: <span id="kpiWorstScore">--</span></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-kpi p-3 chart-container">
          <div class="small-muted">Brecha (Mejor - Peor)</div>
          <h2 id="kpiGap">--</h2>
          <div class="small-muted">Indicador de desigualdad regional</div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3">
      <div class="col-lg-8">
        <div class="chart-container p-3">
          <h6>Evolución temporal del promedio nacional</h6>
          <canvas id="lineEvolution" height="140"></canvas>
        </div>

        <div class="chart-container p-3 mt-3">
          <h6>Rendimiento por provincia (ranking)</h6>
          <canvas id="barProvinces" height="240"></canvas>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="chart-container p-3 mb-3">
          <h6>Dispersión: SES vs Puntaje</h6>
          <canvas id="scatterSES" height="260"></canvas>
        </div>

        <div class="chart-container p-3">
          <h6>Tabla de datos (filtrada)</h6>
          <div style="max-height:240px; overflow:auto;">
            <table class="table table-sm" id="tableData">
              <thead class="table-light"><tr><th>Prov</th><th>Nivel</th><th>Año</th><th>Puntaje</th><th>SES</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-4 small-muted">Datos de ejemplo generados — reemplazá con tus datasets reales (CSV/JSON). Si querés que integre un dataset real, subímelo o indicame la URL.</footer>
  </div>

<script>
// --- Datos de ejemplo ---
const sampleData = (() => {
  const provinces = ['Buenos Aires','Córdoba','Santa Fe','Mendoza','Tucumán','Salta','Neuquén','Misiones','Chaco','La Pampa','Río Negro','Provincia de Buenos Aires','San Juan','Corrientes','Formosa','Entre Ríos','Jujuy','Catamarca','Santiago del Estero','San Luis'];
  const levels = ['Primaria','Secundaria'];
  const years = [2016,2017,2018,2019,2021,2022,2023];
  const data = [];
  for (const y of years) {
    for (const prov of provinces) {
      for (const lvl of levels) {
        // generar puntaje base por provincia (simulado)
        const base = 45 + (provinces.indexOf(prov) % 10) + (lvl === 'Secundaria' ? 2 : 0);
        // variación por año
        const yearAdj = (y - 2016) * (Math.random()*1.2);
        const ses = Math.max(0.2, Math.min(1.0, Math.random()*0.7 + (provinces.indexOf(prov)%5)*0.08));
        const score = Math.round(Math.min(100, Math.max(20, base + yearAdj + (ses-0.5)*20 + (Math.random()-0.5)*6)));
        data.push({province: prov, level: lvl, year: y, score: score, ses: parseFloat(ses.toFixed(2))});
      }
    }
  }
  return {data, years, provinces, levels};
})();

// --- Referencias a DOM ---
const selectYear = document.getElementById('selectYear');
const selectLevel = document.getElementById('selectLevel');
const kpiAvg = document.getElementById('kpiAvg');
const kpiYear = document.getElementById('kpiYear');
const kpiLevel = document.getElementById('kpiLevel');
const kpiBest = document.getElementById('kpiBest');
const kpiWorst = document.getElementById('kpiWorst');
const kpiBestScore = document.getElementById('kpiBestScore');
const kpiWorstScore = document.getElementById('kpiWorstScore');
const kpiGap = document.getElementById('kpiGap');
const tableBody = document.querySelector('#tableData tbody');
const btnDownload = document.getElementById('btnDownload');

// --- Inicializar selects ---
function fillFilters(){
  // años
  selectYear.innerHTML = '';
  sampleData.years.slice().reverse().forEach(y=>{
    const opt = document.createElement('option'); opt.value = y; opt.textContent = y; selectYear.appendChild(opt);
  });
  // niveles
  selectLevel.innerHTML = '';
  const optAll = document.createElement('option'); optAll.value = 'All'; optAll.textContent = 'Todos los niveles'; selectLevel.appendChild(optAll);
  sampleData.levels.forEach(l=>{ const opt = document.createElement('option'); opt.value = l; opt.textContent = l; selectLevel.appendChild(opt); });
}

// --- Filtrar datos ---
function getFiltered(){
  const year = parseInt(selectYear.value);
  const level = selectLevel.value;
  return sampleData.data.filter(d=> d.year===year && (level==='All' || d.level===level));
}

// --- KPI y tabla ---
function updateKPIsAndTable(filtered){
  if(filtered.length===0){ kpiAvg.textContent='-'; return; }
  const avg = Math.round(filtered.reduce((s,d)=>s+d.score,0)/filtered.length);
  kpiAvg.textContent = avg;
  kpiYear.textContent = 'Año ' + selectYear.value;
  kpiLevel.textContent = (selectLevel.value==='All' ? 'Todos' : selectLevel.value);
  // best/worst
  const grouped = {};
  filtered.forEach(r=>{ grouped[r.province]=(grouped[r.province]||[]).concat(r.score); });
  const provAvg = Object.entries(grouped).map(([p,scores])=>({p,avg:Math.round(scores.reduce((a,b)=>a+b,0)/scores.length)}));
  provAvg.sort((a,b)=>b.avg-a.avg);
  kpiBest.textContent = provAvg[0].p;
  kpiBestScore.textContent = provAvg[0].avg;
  kpiWorst.textContent = provAvg[provAvg.length-1].p;
  kpiWorstScore.textContent = provAvg[provAvg.length-1].avg;
  kpiGap.textContent = (provAvg[0].avg - provAvg[provAvg.length-1].avg) + ' pts';
  // tabla
  tableBody.innerHTML = '';
  filtered.slice().sort((a,b)=>b.score-a.score).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.province}</td><td>${r.level}</td><td>${r.year}</td><td>${r.score}</td><td>${r.ses}</td>`;
    tableBody.appendChild(tr);
  });
}

// --- Charts ---
let chartLine=null, chartBar=null, chartScatter=null;
function drawLine(evolution){
  const ctx = document.getElementById('lineEvolution').getContext('2d');
  if(chartLine) chartLine.destroy();
  chartLine = new Chart(ctx, {
    type: 'line',
    data: { labels: evolution.years, datasets: [{ label: 'Promedio Nacional', data: evolution.values, tension:0.3, fill:true }] },
    options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ suggestedMin:20, suggestedMax:100 } } }
  });
}

function drawBar(provAvg){
  const ctx = document.getElementById('barProvinces').getContext('2d');
  if(chartBar) chartBar.destroy();
  chartBar = new Chart(ctx, {
    type: 'bar',
    data: { labels: provAvg.map(p=>p.p), datasets:[{ label:'Puntaje', data:provAvg.map(p=>p.avg), barPercentage:0.7 }] },
    options: { indexAxis:'y', responsive:true, plugins:{ legend:{display:false} }, scales:{ x:{ suggestedMin:20, suggestedMax:100 } } }
  });
}

function drawScatter(points){
  const ctx = document.getElementById('scatterSES').getContext('2d');
  if(chartScatter) chartScatter.destroy();
  chartScatter = new Chart(ctx, {
    type:'scatter',
    data: { datasets:[{ label:'Escuelas (SES vs Puntaje)', data: points, pointRadius:6, showLine:false }] },
    options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ x:{ title:{display:true, text:'SES (índice)'} }, y:{ title:{display:true, text:'Puntaje'} } } }
  });
}

// --- Calcular evolución ---
function calculateEvolution(level){
  const years = sampleData.years.slice().sort((a,b)=>a-b);
  const values = years.map(y=>{
    const subset = sampleData.data.filter(d=> d.year===y && (level==='All' || d.level===level));
    if(subset.length===0) return null;
    return Math.round(subset.reduce((s,d)=>s+d.score,0)/subset.length);
  });
  return {years, values};
}

// --- Actualizar todos los componentes ---
function updateAll(){
  const filtered = getFiltered();
  updateKPIsAndTable(filtered);
  // bar: average per province for selected year/level
  const grouped = {};
  filtered.forEach(r=> grouped[r.province]=(grouped[r.province]||[]).concat(r.score));
  const provAvg = Object.entries(grouped).map(([p,scores])=>({p,avg:Math.round(scores.reduce((a,b)=>a+b,0)/scores.length)}));
  provAvg.sort((a,b)=>b.avg-a.avg);
  drawBar(provAvg);
  // line: evolution (national) for selected level
  const evo = calculateEvolution(selectLevel.value);
  drawLine(evo);
  // scatter: draw points (take up to 200 for performance)
  const scatterPoints = filtered.map(r=>({x:r.ses, y:r.score})).slice(0,400);
  drawScatter(scatterPoints);
}

// --- Descarga CSV ---
function downloadCSV(){
  const filtered = getFiltered();
  if(filtered.length===0) return alert('No hay datos para descargar con los filtros actuales.');
  const header = ['province','level','year','score','ses'];
  const rows = [header.join(',')].concat(filtered.map(r=>[r.province,r.level,r.year,r.score,r.ses].join(',')));
  const csv = rows.join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `rendimiento_matematica_${selectYear.value}_${selectLevel.value}.csv`; document.body.appendChild(a); a.click(); a.remove();
}

// --- Eventos ---
selectYear.addEventListener('change', updateAll);
selectLevel.addEventListener('change', updateAll);
btnDownload.addEventListener('click', downloadCSV);

// --- Init ---
(function init(){
  fillFilters();
  // set defaults
  selectYear.value = sampleData.years[sampleData.years.length-1];
  selectLevel.value = 'All';
  // initial render
  updateAll();
})();

</script>
</body>
</html>
